<div class="container">
  <!-- Messages -->
  @if (errorMessage()) {
    <div class="alert alert-danger">{{ errorMessage() }}</div>
  }
  @if (successMessage()) {
    <div class="alert alert-success">{{ successMessage() }}</div>
  }
  @if (isLoading()) {
    <div class="loading-overlay">
      <div class="spinner"></div>
      <span>Cargando...</span>
    </div>
  }

  <!-- INFORMACIÓN DEL PACIENTE -->
  <section class="card patient-info">
    <h2>Información del Paciente</h2>
    <div class="form-row">
      <div class="form-group">
        <label for="nombre">Nombre:</label>
        <input type="text" id="nombre" placeholder="Juan Pérez"
               [value]="patientForm().full_name"
               (input)="updatePatientForm('full_name', $any($event.target).value)">
      </div>
      <div class="form-group">
        <label for="numControl">Número de Control:</label>
        <input type="text" id="numControl" placeholder="12345678"
               [value]="patientForm().control_number"
               (input)="updatePatientForm('control_number', $any($event.target).value)">
      </div>
      <div class="form-group">
        <label for="sexo">Sexo:</label>
        <select id="sexo" [value]="patientForm().gender || ''"
                (change)="updatePatientForm('gender', $any($event.target).value || undefined)">
          <option value="">Seleccionar</option>
          <option value="male">Masculino</option>
          <option value="female">Femenino</option>
          <option value="other">Otro</option>
        </select>
      </div>
      <div class="form-group">
        <label for="carrera">Carrera o Área:</label>
        <input type="text" id="carrera" placeholder="Sistemas"
               [value]="patientForm().career"
               (input)="updatePatientForm('career', $any($event.target).value)">
      </div>
      <div class="form-group">
        <label for="edad">Edad:</label>
        <input type="number" id="edad" class="small-input" placeholder="22"
               [value]="patientForm().age"
               (input)="updatePatientForm('age', +$any($event.target).value || undefined)">
      </div>
    </div>
    <div class="btn-group">
      <button class="btn btn-save" (click)="savePatientInfo()" [disabled]="isLoading()">
        {{ selectedPatient() ? 'Actualizar Información' : 'Guardar Información' }}
      </button>
      @if (selectedPatient()) {
        <button class="btn btn-clear" (click)="clearForm()">Nuevo Paciente</button>
      }
    </div>
  </section>

  <!-- TABLA DE PACIENTES -->
  <section class="card patient-table">
    <h2>Pacientes Registrados</h2>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Núm. Control</th>
            <th>Sexo</th>
            <th>Edad</th>
            <th>Carrera</th>
          </tr>
        </thead>
        <tbody>
          @for (patient of patients(); track patient.id) {
            <tr [class.selected]="selectedPatient()?.id === patient.id"
                (click)="selectPatient(patient)">
              <td>{{ patient.id?.substring(0, 8) || '-' }}</td>
              <td>{{ patient.full_name }}</td>
              <td>{{ patient.control_number || '-' }}</td>
              <td>{{ getGenderDisplay(patient.gender) }}</td>
              <td>{{ patient.age || '-' }}</td>
              <td>{{ patient.career || '-' }}</td>
            </tr>
          } @empty {
            <tr>
              <td colspan="6" class="text-center">No hay pacientes registrados</td>
            </tr>
          }
        </tbody>
      </table>
    </div>
    <div class="table-actions">
      <button class="btn btn-danger" (click)="deletePatient()" [disabled]="!selectedPatient() || isLoading()">
        Eliminar
      </button>
      <button class="btn btn-primary" (click)="savePatientInfo()" [disabled]="!selectedPatient() || isLoading()">
        Guardar Cambios
      </button>
    </div>
  </section>

  <!-- DIAGNÓSTICO -->
  <section class="card diagnostico">
    <h2>Diagnóstico</h2>
    <div class="checkbox-group">
      <label>
        <input type="checkbox" [checked]="diagnosis().malnutrition"
               (change)="updateDiagnosis('malnutrition', $any($event.target).checked)"> Desnutrición
      </label>
      <label>
        <input type="checkbox" [checked]="diagnosis().underweight"
               (change)="updateDiagnosis('underweight', $any($event.target).checked)"> Bajo Peso
      </label>
      <label>
        <input type="checkbox" [checked]="diagnosis().healthy_weight"
               (change)="updateDiagnosis('healthy_weight', $any($event.target).checked)"> Peso Sano
      </label>
      <label>
        <input type="checkbox" [checked]="diagnosis().overweight"
               (change)="updateDiagnosis('overweight', $any($event.target).checked)"> Sobrepeso
      </label>
      <label>
        <input type="checkbox" [checked]="diagnosis().obesity_1"
               (change)="updateDiagnosis('obesity_1', $any($event.target).checked)"> Obesidad 1
      </label>
      <label>
        <input type="checkbox" [checked]="diagnosis().obesity_2"
               (change)="updateDiagnosis('obesity_2', $any($event.target).checked)"> Obesidad 2
      </label>
      <label>
        <input type="checkbox" [checked]="diagnosis().obesity_3"
               (change)="updateDiagnosis('obesity_3', $any($event.target).checked)"> Obesidad 3
      </label>
      <label>
        <input type="checkbox" [checked]="diagnosis().diabetes"
               (change)="updateDiagnosis('diabetes', $any($event.target).checked)"> Diabetes
      </label>
      <label>
        <input type="checkbox" [checked]="diagnosis().hypertension"
               (change)="updateDiagnosis('hypertension', $any($event.target).checked)"> Hipertensión
      </label>
      <label>
        <input type="checkbox" [checked]="diagnosis().dyslipidemia"
               (change)="updateDiagnosis('dyslipidemia', $any($event.target).checked)"> Dislipidemias
      </label>
      <label>
        <input type="checkbox" [checked]="diagnosis().nephropathy"
               (change)="updateDiagnosis('nephropathy', $any($event.target).checked)"> Nefropatías
      </label>
      <div class="form-group">
        <label for="otros">Otros:</label>
        <input type="text" id="otros" placeholder="Especificar..."
               [value]="diagnosis().other"
               (input)="updateDiagnosis('other', $any($event.target).value)">
      </div>
    </div>
    <button class="btn btn-save" (click)="saveDiagnosis()" [disabled]="!selectedPatient() || isLoading()">
      Guardar Diagnóstico
    </button>
  </section>

  <!-- GRID DE SECCIONES -->
  <div class="main-grid">

    <!-- COLUMNA 1 -->
    <div class="grid-col">
      <section class="card">
        <h3>Control de Expedientes</h3>
        <div class="form-group-col">
          <label for="orientaciones">Orientaciones:</label>
          <input type="text" id="orientaciones"
                 [value]="medicalRecords().orientations"
                 (input)="updateMedicalRecords('orientations', $any($event.target).value)">
          <label for="hcn">HCN:</label>
          <input type="text" id="hcn"
                 [value]="medicalRecords().hcn"
                 (input)="updateMedicalRecords('hcn', $any($event.target).value)">
          <label for="plan">Plan de Alimentación:</label>
          <select id="plan" [value]="medicalRecords().meal_plan_type"
                  (change)="updateMedicalRecords('meal_plan_type', $any($event.target).value)">
            <option value="">Seleccionar plan...</option>
            <option value="standard">Plan Estándar</option>
            <option value="low_carb">Bajo en Carbohidratos</option>
            <option value="high_protein">Alto en Proteínas</option>
            <option value="balanced">Balanceado</option>
            <option value="vegetarian">Vegetariano</option>
            <option value="custom">Personalizado</option>
          </select>
          <label for="primeraVez">1era vez:</label>
          <input type="date" id="primeraVez" class="small-input"
                 [value]="medicalRecords().first_visit"
                 (input)="updateMedicalRecords('first_visit', $any($event.target).value)">
          <label for="seguimiento">Seguimiento:</label>
          <input type="date" id="seguimiento" class="small-input"
                 [value]="medicalRecords().follow_up"
                 (input)="updateMedicalRecords('follow_up', $any($event.target).value)">
        </div>
        <button class="btn btn-save btn-xs" (click)="saveMedicalRecords()" [disabled]="!selectedPatient() || isLoading()">
          Guardar
        </button>
      </section>
    </div>

    <!-- COLUMNA 2 -->
    <div class="grid-col">
      <!-- Placeholder for future sections -->
    </div>

    <!-- ANTROPOMETRÍA (full width) -->
    <section class="card antropometria">
      <h2>Antropometría</h2>
      <div class="form-grid-antropo">
        <div class="form-group">
          <label for="peso">Peso (kg):</label>
          <input type="number" id="peso" step="0.1"
                 [value]="anthropometry().weight_kg"
                 (input)="updateAnthropometry('weight_kg', +$any($event.target).value || undefined)">
        </div>
        <div class="form-group">
          <label for="talla">Talla (cm):</label>
          <input type="number" id="talla" step="0.1"
                 [value]="anthropometry().height_cm"
                 (input)="updateAnthropometry('height_cm', +$any($event.target).value || undefined)">
        </div>
        <div class="form-group">
          <label for="imc">IMC:</label>
          <input type="text" id="imc" [value]="calculatedBmi()" disabled>
        </div>
        <div class="form-group">
          <label for="grasa">% Grasa Corporal:</label>
          <input type="number" id="grasa" step="0.1"
                 [value]="anthropometry().body_fat_percentage"
                 (input)="updateAnthropometry('body_fat_percentage', +$any($event.target).value || undefined)">
        </div>
        <div class="form-group">
          <label for="musculo">Masa Muscular (kg):</label>
          <input type="number" id="musculo" step="0.1"
                 [value]="anthropometry().muscle_mass_kg"
                 (input)="updateAnthropometry('muscle_mass_kg', +$any($event.target).value || undefined)">
        </div>
        <div class="form-group">
          <label for="cintura">Cintura (cm):</label>
          <input type="number" id="cintura" step="0.1"
                 [value]="anthropometry().waist_cm"
                 (input)="updateAnthropometry('waist_cm', +$any($event.target).value || undefined)">
        </div>
        <div class="form-group">
          <label for="cadera">Cadera (cm):</label>
          <input type="number" id="cadera" step="0.1"
                 [value]="anthropometry().hip_cm"
                 (input)="updateAnthropometry('hip_cm', +$any($event.target).value || undefined)">
        </div>
      </div>
      <div class="btn-group">
        <button class="btn btn-save" (click)="saveAnthropometry()" [disabled]="!selectedPatient() || isLoading()">
          Guardar Antropometría
        </button>
        <button class="btn btn-clear" (click)="clearAnthropometry()">Limpiar</button>
      </div>
    </section>

  </div>
</div>
